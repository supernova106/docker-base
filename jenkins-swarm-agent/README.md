# Jenkins Swarm Slave Docker

Simple image that runs the jenkins swarm plugin which connects to a given master using parameters from the Docker secret

## Build

Update `.env` file with new versions and docker registry endpoint

Run `make build`

Run `make push` to publish new image

## Usage

```shell
docker service create \
    --mode=global \
    --name jenkins-swarm-agent \
    -e LABELS=docker-test \
    --mount "type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock" \
    --mount "type=bind,source=/tmp/,target=/tmp/" \
    --secret source=jenkins-v1,target=jenkins \
    uscregistry.nonprod.example.local/jenkins-swarm-agent
```

- `mode=global` when we add new nodes to the Docker cluster they will all connect to the jenkins master to serve as slaves
- `mount "type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock"` we mount the Docker socket so that we can use the Docker client inside a container to start new containers or services directly on the host. This is a better approach than Docker in Docker
- `mount "type=bind,source=/tmp/,target=/tmp/"` all containers can share files generated by the same Jenkins job
- `LABELS=docker-test` the jenkins slave label. This is used when you define where to run each pipeline step - the labels need to match the ones used in the Jenkinsfile - node("docker-test") , node("docker-stage") , node("docker-prod")
- `secret source=jenkins-v1,target=jenkins` using the secret created in the previous step, needs to match a user on the jenkins master. The source file will be copied to `/run/secrets/jenkins` in the container.

## Contact

Bean Nguyen
